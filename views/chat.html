<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Chat App | Home</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .navbar {
            background-color: #333;
            color: white;
            padding: 1em;
        }
        .navbar ul {
            display: flex;
            list-style-type: none;
        }
        .navbar ul li {
            margin: 0 1em;
        }
        .chat-app {
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .chat-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
        }
        .input-area {
            display: flex;
            align-items: center;
        }
        .input-area input {
            width: 100%;
            padding: 10px;
        }
        .input-area button {
            margin-left: 10px;
        }
        .message {
            background-color: #f1f1f1;
            padding: 5px;
            margin: 5px 0;
        }
        .hidden {
            display: none;
        }
        .dropdown-menu {
            position: absolute;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <ul>
            <li>
                <button class="open-sidebar">☰</button>
                <div class="group-sidebar mysidebar" style="display: none">
                    <button class="close-sidebar">X</button>
                    <button id="create-group-button">+ Create Group</button>
                    <span>
                        <h5 id="group-name">Select a Group</h5>
                    </span>
                    <span>
                        <input type="text" id="group-search" placeholder="Search..." />
                    </span>
                    <span>
                        <ul id="group-list"></ul>
                    </span>
                </div>
            </li>
            <li>
                <input type="search" placeholder="Invite Link" id="inviteLink" />
                <button id="invite-button">Enter</button>
            </li>
            <li class="user-info">
                <span id="user-name"></span>
                <button id="logout-button">Logout</button>
            </li>
            <li>
                <h5>Online Users</h5>
                <ul id="online-list"></ul>
            </li>
        </ul>
    </div>

    <div class="chat-app">
        <div class="header-container">
            <button id="menu-button">☰</button>
            <div id="dropdown-menu" class="dropdown-menu hidden">
                <button id="generate-link">Generate Invite Link</button>
                <button id="view-members">View Members</button>
                <button id="delete-group">Delete Group</button>
                <button id="leave-group">Leave Group</button>
            </div>
            <div>
                <p class="welcome-message">ChatGram</p>
            </div>
        </div>

        <div id="chat-area" class="chat-area"></div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="Type a message..." />
            <button id="send-button">Send</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>
    <script>
        const creteGroupButton = document.getElementById("create-group-button");
        const input = document.getElementById("message-input");
        const sendButton = document.getElementById("send-button");
        const logoutButton = document.getElementById("logout-button");
        const generateButton = document.getElementById("generate-link");
        const groupNameTag = document.getElementById("group-name");
        const groupList = document.getElementById("group-list");
        const groupInput = document.getElementById("group-search");
        const inviteInput = document.getElementById("inviteLink");
        const inviteButton = document.getElementById("invite-button");
        const menuButton = document.getElementById("menu-button");
        const dropdownMenu = document.getElementById("dropdown-menu");
        const userName = document.getElementById("user-name");
        const leaveGroupButton = document.getElementById("leave-group");
        const onlineClientList = document.getElementById("online-list");

        // important variables
        let currentGroupId = null;
        const token = localStorage.getItem("token");
        const socket = io("http://localhost:3000", {
            extraHeaders: {
                Authorization: `${token}`,
            },
        });

        // Initialize the chat app
        window.addEventListener("DOMContentLoaded", async () => {
            sendButton.addEventListener("click", sendMessage);
            logoutButton.addEventListener("click", logout);
            leaveGroupButton.addEventListener("click", leaveGroup);
            await fetchGroups();
        });

        socket.on("messageReceived", (data) => {
            if (data.groupId === currentGroupId) {
                displayLiveMessages(data);
            }
        });

        function displayLiveMessages(message) {
            const chatArea = document.getElementById("chat-area");
            const messageElement = document.createElement("li");
            messageElement.classList.add("message");
            messageElement.textContent = `${message.user}: ${message.message}`;
            chatArea.appendChild(messageElement);
        }

        function displayMessages(messages) {
            const chatArea = document.getElementById("chat-area");
            chatArea.innerHTML = "";
            messages.forEach(displayMessage);
        }

        // Display a single message in the chat area
        function displayMessage(message) {
            const chatArea = document.getElementById("chat-area");
            const messageElement = document.createElement("li");
            messageElement.classList.add("message");
            messageElement.textContent = `${message.User.name}: ${message.message}`;
            chatArea.appendChild(messageElement);
        }

        function logout() {
            localStorage.removeItem("token");
            window.location.href = "/public/login/login.html";
        }

        async function fetchGroups() {
            try {
                const response = await axios.get("http://localhost:3000/api/groups", {
                    headers: { Authorization: `${token}` },
                });
                userName.innerText = response.data.userName;
                displayGroups(response.data.groups);
            } catch (error) {
                console.error(error);
            }
        }

        function displayGroups(groups) {
            groupList.innerHTML = "";
            groups.forEach((group) => {
                const li = document.createElement("li");
                li.textContent = group.chatGroup.name;
                li.addEventListener("click", () => loadGroupChat(group.groupId, group.chatGroup.name));
                groupList.appendChild(li);
            });
        }

        creteGroupButton.addEventListener("click", async () => {
            const groupName = prompt("Enter group name");
            if (groupName) {
                try {
                    await axios.post(
                        "http://localhost:3000/api/groups",
                        { name: groupName },
                        { headers: { Authorization: `${token}` } }
                    );
                    fetchGroups();
                } catch (error) {
                    console.error(error);
                }
            }
        });

        async function loadGroupChat(groupId, groupName) {
            currentGroupId = groupId;
            // Join the current group
            socket.emit("joinGroup", currentGroupId);
            groupNameTag.textContent = groupName;
            await fetchGroupMessages(groupId);
        }

        async function fetchGroupMessages(groupId) {
            try {
                const response = await axios.get(
                    `http://localhost:3000/api/group/messages/${groupId}`,
                    { headers: { Authorization: `${token}` } }
                );
                displayMessages(response.data.messages);
            } catch (error) {
                console.error(error);
            }
        }

        async function sendMessage() {
            const message = input.value.trim();

            if (message && currentGroupId) {
                try {
                    socket.emit("messageSent", { groupId: currentGroupId, message });
                    input.value = "";
                } catch (error) {
                    console.error(error);
                }
            }
        }

        // Dropdown menu functionality
        menuButton.addEventListener("click", () => {
            dropdownMenu.classList.toggle("hidden");
        });

        // Generate Invite Link
        generateButton.addEventListener("click", async () => {
            try {
                const groupId = currentGroupId;
                const response = await axios.post(
                    "http://localhost:3000/api/group/invite",
                    { groupId },
                    { headers: { Authorization: `${token}` } }
                );
                dropdownMenu.classList.add("hidden");
                inviteInput.value = response.data.inviteLink;
            } catch (error) {
                console.error(error);
            }
        });

        async function leaveGroup() {
            try {
                await axios.post(
                    `http://localhost:3000/api/group/leave/${currentGroupId}`,
                    {},
                    { headers: { Authorization: `${token}` } }
                );
                groupNameTag.textContent = "Select a Group";
                currentGroupId = null;
                fetchGroups();
            } catch (error) {
                console.error(error);
            }
        }
    </script>
</body>
</html>
